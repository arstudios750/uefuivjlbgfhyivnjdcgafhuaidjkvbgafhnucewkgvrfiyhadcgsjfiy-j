<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CGprints Orders</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    background: #0d0d0d;
    color: white;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
  }

  h1 {
    text-align: center;
    margin-bottom: 25px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: #151515;
    border-radius: 10px;
    overflow: hidden;
  }

  th, td {
    padding: 12px;
    border-bottom: 1px solid #222;
    text-align: left;
  }

  th {
    background: linear-gradient(90deg, red, blue, purple);
  }

  tr:hover {
    background: #1f1f1f;
  }

  button.delete-btn {
    padding: 5px 10px;
    border: none;
    border-radius: 6px;
    background: #ff4d4d;
    color: white;
    cursor: pointer;
  }

  button.delete-btn:hover {
    background: #ff1a1a;
  }

  #loader {
    text-align: center;
    margin-top: 40px;
    font-size: 1.2rem;
  }
</style>
</head>
<body>

<h1>CGprints - All Orders</h1>

  <input type="text" id="searchInput" placeholder="Search orders..." style="margin-bottom:10px; padding:5px; width:100%;">
  
<div id="loader">Loading orders...</div>

<table id="ordersTable" style="display:none;">
  <thead>
    <tr>
      <th>Item</th>
      <th>Email</th>
      <th>Quantity</th>
      <th>Total Cost</th>
      <th>Time</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="ordersBody"></tbody>
</table>

<script>
// JSONBin config
const BIN_ID = "691357bbae596e708f52c356";
const API_KEY = "$2a$10$UGn2PaD5YfJ1z7c4xo4f4e0WHugS2BMfS4yrYRsDqukqty/V38OBO";
const url = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

let orders = [];

// Fetch orders
function loadOrders() {
  fetch(url, { method: "GET", headers: { "X-Master-Key": API_KEY } })
    .then(res => res.json())
    .then(data => {
      orders = data.record?.orders || [];
      renderOrders();
    })
    .catch(err => {
      console.error(err);
      document.getElementById("loader").textContent = "Error loading orders.";
    });
}

// Render orders table
function renderOrders() {
  const body = document.getElementById("ordersBody");
  body.innerHTML = "";

  if (orders.length === 0) {
    document.getElementById("loader").textContent = "No orders yet.";
    document.getElementById("ordersTable").style.display = "none";
    return;
  }

  document.getElementById("loader").style.display = "none";
  document.getElementById("ordersTable").style.display = "table";

  // Sort newest first
  orders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

  orders.forEach((order, index) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${order.item}</td>
      <td>${order.email}</td>
      <td>${order.quantity}</td>
      <td>$${order.totalCost}</td>
      <td>${order.timestamp}</td>
      <td><button class="delete-btn" onclick="deleteOrder(${index})">Delete</button></td>
    `;
    body.appendChild(row);
  });
}
  // Search filter
document.getElementById("searchInput").addEventListener("input", (e) => {
  const term = e.target.value.toLowerCase();
  const filtered = orders.filter(o =>
    o.item.toLowerCase().includes(term) ||
    o.email.toLowerCase().includes(term)
  );
  renderOrders(filtered);
});

// Modify renderOrders to accept filtered list
function renderOrders(filteredOrders = orders) {
  const body = document.getElementById("ordersBody");
  body.innerHTML = "";

  if(filteredOrders.length === 0){
    document.getElementById("loader").textContent = "No orders match your search.";
    document.getElementById("ordersTable").style.display = "none";
    return;
  }

  document.getElementById("loader").style.display = "none";
  document.getElementById("ordersTable").style.display = "table";

  // Sort newest first
  filteredOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

  filteredOrders.forEach((order, index) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${order.item}</td>
      <td>${order.email}</td>
      <td>${order.quantity}</td>
      <td>$${order.totalCost}</td>
      <td>${order.timestamp}</td>
      <td><button class="delete-btn" onclick="deleteOrder(${index})">Delete</button></td>
    `;
    body.appendChild(row);
  });
}


// Delete order by index
function deleteOrder(index) {
  if (!confirm("Are you sure you want to delete this order?")) return;

  orders.splice(index, 1);

  // Update JSONBin
  fetch(url, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      "X-Master-Key": API_KEY
    },
    body: JSON.stringify({ orders: orders })
  })
  .then(() => {
    renderOrders();
    alert("Order deleted!");
  })
  .catch(err => {
    console.error(err);
    alert("Error deleting order.");
  });
}

// Load orders on page load
loadOrders();
  setInterval(loadOrders, 30000);

</script>

</body>
</html>
